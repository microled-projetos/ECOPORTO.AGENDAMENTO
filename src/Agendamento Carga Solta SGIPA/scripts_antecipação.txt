ALTER TABLE TB_AV_IMAGEM ADD FLAG_AGENDAMENTO NUMBER(1);
ALTER TABLE TB_AV_IMAGEM ADD CNTR NUMBER;
ALTER TABLE TB_AG_CS ADD FLAG_LIBERADO NUMBER(1);
ALTER TABLE OPERADOR.TB_AG_MOTORISTAS ADD DOC_MOTORISTA NUMBER;
ALTER TABLE OPERADOR.TB_AG_VEICULOS ADD DOC_CAVALO NUMBER;
ALTER TABLE OPERADOR.TB_AG_VEICULOS ADD DOC_CARRETA NUMBER;
ALTER TABLE OPERADOR.TB_CAD_TRANSPORTADORAS ADD EMAIL_AGENDAMENTO VARCHAR2(500);
ALTER TABLE TB_PARAMETROS_SISTEMA ADD FLAG_BLOQUEIA_PROTOCOLO NUMBER(1);
UPDATE TB_PARAMETROS_SISTEMA SET FLAG_BLOQUEIA_PROTOCOLO=1;
ALTER TABLE TB_PARAMETROS_SISTEMA ADD DIR_AVERBA_DOCS VARCHAR2(150);
ALTER TABLE TB_CNTR_BL ADD FLAG_LIBERADO NUMBER(1);
ALTER TABLE TB_CNTR_BL ADD IMPRESSO NUMBER(1);                
ALTER TABLE TB_PARAMETROS_SISTEMA ADD EMAIL_REGISTRO VARCHAR2(500);
UPDATE TB_PARAMETROS_SISTEMA SET EMAIL_REGISTRO = 'martinelli@microled.com.br';

CREATE SEQUENCE SGIPA.SEQ_AGENDAMENTO_DOC_VINCULO
  START WITH 1
  MAXVALUE 9999999999999999999999999999
  MINVALUE 1
  NOCYCLE
  NOCACHE
  NOORDER;

CREATE TABLE SGIPA.TB_AGENDAMENTO_DOC_VINCULO(
    AUTONUM INT NOT NULL PRIMARY KEY,
    AUTONUM_DOCUMENTO NUMBER,
    AUTONUM_AGENDAMENTO NUMBER,
    LOTE NUMBER,
    TIPO_AGENDAMENTO VARCHAR2(2),
    DATA_ENVIO DATE,
    NOME_ARQUIVO VARCHAR2(150),
    ARQUIVO BLOB
);

CREATE TABLE SGIPA.TB_AGENDAMENTO_DOC(
    AUTONUM INT NOT NULL PRIMARY KEY,    
    DESCRICAO VARCHAR2(50)
);

ALTER TABLE TB_AGENDAMENTO_DOC_VINCULO ADD AUTONUM_AV_IMAGEM NUMBER;

INSERT INTO SGIPA.TB_AGENDAMENTO_DOC (AUTONUM, DESCRICAO) VALUES (1, 'BL Original');
INSERT INTO SGIPA.TB_AGENDAMENTO_DOC (AUTONUM, DESCRICAO) VALUES (2, 'Guia ICMS');
INSERT INTO SGIPA.TB_AGENDAMENTO_DOC (AUTONUM, DESCRICAO) VALUES (3, 'Nota Fiscal');
INSERT INTO SGIPA.TB_AGENDAMENTO_DOC (AUTONUM, DESCRICAO) VALUES (4, 'CI');
INSERT INTO SGIPA.TB_AGENDAMENTO_DOC (AUTONUM, DESCRICAO) VALUES (5, 'DSI/DSI MANUAL');
INSERT INTO SGIPA.TB_AGENDAMENTO_DOC (AUTONUM, DESCRICAO) VALUES (6, 'DTA/DTAs');
INSERT INTO SGIPA.TB_AGENDAMENTO_DOC (AUTONUM, DESCRICAO) VALUES (7, 'CNH');
INSERT INTO SGIPA.TB_AGENDAMENTO_DOC (AUTONUM, DESCRICAO) VALUES (8, 'Doc. Cavalo');
INSERT INTO SGIPA.TB_AGENDAMENTO_DOC (AUTONUM, DESCRICAO) VALUES (9, 'Doc. Carreta');
INSERT INTO SGIPA.TB_AGENDAMENTO_DOC (AUTONUM, DESCRICAO) VALUES (10, 'DOC.Saída (OC, MN, CR)');

CREATE SEQUENCE SGIPA.SEQ_AMR_AGENDAMENTO_DOC
  START WITH 1
  MAXVALUE 9999999999999999999999999999
  MINVALUE 1
  NOCYCLE
  NOCACHE
  NOORDER;
  
CREATE TABLE SGIPA.TB_AMR_AGENDAMENTO_DOC(
    AUTONUM INT NOT NULL PRIMARY KEY,    
    AUTONUM_AGENDAMENTO_DOC NUMBER,
    AUTONUM_TIPO_DOC NUMBER
);

INSERT INTO SGIPA.TB_AMR_AGENDAMENTO_DOC (AUTONUM, AUTONUM_AGENDAMENTO_DOC, AUTONUM_TIPO_DOC) VALUES (SEQ_AMR_AGENDAMENTO_DOC.NEXTVAL, 1, 1);
INSERT INTO SGIPA.TB_AMR_AGENDAMENTO_DOC (AUTONUM, AUTONUM_AGENDAMENTO_DOC, AUTONUM_TIPO_DOC) VALUES (SEQ_AMR_AGENDAMENTO_DOC.NEXTVAL, 1, 2);
INSERT INTO SGIPA.TB_AMR_AGENDAMENTO_DOC (AUTONUM, AUTONUM_AGENDAMENTO_DOC, AUTONUM_TIPO_DOC) VALUES (SEQ_AMR_AGENDAMENTO_DOC.NEXTVAL, 1, 8);
INSERT INTO SGIPA.TB_AMR_AGENDAMENTO_DOC (AUTONUM, AUTONUM_AGENDAMENTO_DOC, AUTONUM_TIPO_DOC) VALUES (SEQ_AMR_AGENDAMENTO_DOC.NEXTVAL, 1, 9);

INSERT INTO SGIPA.TB_AMR_AGENDAMENTO_DOC (AUTONUM, AUTONUM_AGENDAMENTO_DOC, AUTONUM_TIPO_DOC) VALUES (SEQ_AMR_AGENDAMENTO_DOC.NEXTVAL, 2, 1);
INSERT INTO SGIPA.TB_AMR_AGENDAMENTO_DOC (AUTONUM, AUTONUM_AGENDAMENTO_DOC, AUTONUM_TIPO_DOC) VALUES (SEQ_AMR_AGENDAMENTO_DOC.NEXTVAL, 2, 2);

INSERT INTO SGIPA.TB_AMR_AGENDAMENTO_DOC (AUTONUM, AUTONUM_AGENDAMENTO_DOC, AUTONUM_TIPO_DOC) VALUES (SEQ_AMR_AGENDAMENTO_DOC.NEXTVAL, 3, 1);

INSERT INTO SGIPA.TB_AMR_AGENDAMENTO_DOC (AUTONUM, AUTONUM_AGENDAMENTO_DOC, AUTONUM_TIPO_DOC) VALUES (SEQ_AMR_AGENDAMENTO_DOC.NEXTVAL, 4, 2);
INSERT INTO SGIPA.TB_AMR_AGENDAMENTO_DOC (AUTONUM, AUTONUM_AGENDAMENTO_DOC, AUTONUM_TIPO_DOC) VALUES (SEQ_AMR_AGENDAMENTO_DOC.NEXTVAL, 5, 2);
INSERT INTO SGIPA.TB_AMR_AGENDAMENTO_DOC (AUTONUM, AUTONUM_AGENDAMENTO_DOC, AUTONUM_TIPO_DOC) VALUES (SEQ_AMR_AGENDAMENTO_DOC.NEXTVAL, 6, 8);
INSERT INTO SGIPA.TB_AMR_AGENDAMENTO_DOC (AUTONUM, AUTONUM_AGENDAMENTO_DOC, AUTONUM_TIPO_DOC) VALUES (SEQ_AMR_AGENDAMENTO_DOC.NEXTVAL, 6, 9);

INSERT INTO SGIPA.TB_AMR_AGENDAMENTO_DOC (AUTONUM, AUTONUM_AGENDAMENTO_DOC, AUTONUM_TIPO_DOC) VALUES (SEQ_AMR_AGENDAMENTO_DOC.NEXTVAL, 7, 1);
INSERT INTO SGIPA.TB_AMR_AGENDAMENTO_DOC (AUTONUM, AUTONUM_AGENDAMENTO_DOC, AUTONUM_TIPO_DOC) VALUES (SEQ_AMR_AGENDAMENTO_DOC.NEXTVAL, 7, 2);
INSERT INTO SGIPA.TB_AMR_AGENDAMENTO_DOC (AUTONUM, AUTONUM_AGENDAMENTO_DOC, AUTONUM_TIPO_DOC) VALUES (SEQ_AMR_AGENDAMENTO_DOC.NEXTVAL, 7, 8);
INSERT INTO SGIPA.TB_AMR_AGENDAMENTO_DOC (AUTONUM, AUTONUM_AGENDAMENTO_DOC, AUTONUM_TIPO_DOC) VALUES (SEQ_AMR_AGENDAMENTO_DOC.NEXTVAL, 7, 9);

INSERT INTO SGIPA.TB_AMR_AGENDAMENTO_DOC (AUTONUM, AUTONUM_AGENDAMENTO_DOC, AUTONUM_TIPO_DOC) VALUES (SEQ_AMR_AGENDAMENTO_DOC.NEXTVAL, 8, 1);
INSERT INTO SGIPA.TB_AMR_AGENDAMENTO_DOC (AUTONUM, AUTONUM_AGENDAMENTO_DOC, AUTONUM_TIPO_DOC) VALUES (SEQ_AMR_AGENDAMENTO_DOC.NEXTVAL, 8, 2);
INSERT INTO SGIPA.TB_AMR_AGENDAMENTO_DOC (AUTONUM, AUTONUM_AGENDAMENTO_DOC, AUTONUM_TIPO_DOC) VALUES (SEQ_AMR_AGENDAMENTO_DOC.NEXTVAL, 8, 8);
INSERT INTO SGIPA.TB_AMR_AGENDAMENTO_DOC (AUTONUM, AUTONUM_AGENDAMENTO_DOC, AUTONUM_TIPO_DOC) VALUES (SEQ_AMR_AGENDAMENTO_DOC.NEXTVAL, 8, 9);

INSERT INTO SGIPA.TB_AMR_AGENDAMENTO_DOC (AUTONUM, AUTONUM_AGENDAMENTO_DOC, AUTONUM_TIPO_DOC) VALUES (SEQ_AMR_AGENDAMENTO_DOC.NEXTVAL, 9, 1);
INSERT INTO SGIPA.TB_AMR_AGENDAMENTO_DOC (AUTONUM, AUTONUM_AGENDAMENTO_DOC, AUTONUM_TIPO_DOC) VALUES (SEQ_AMR_AGENDAMENTO_DOC.NEXTVAL, 9, 2);
INSERT INTO SGIPA.TB_AMR_AGENDAMENTO_DOC (AUTONUM, AUTONUM_AGENDAMENTO_DOC, AUTONUM_TIPO_DOC) VALUES (SEQ_AMR_AGENDAMENTO_DOC.NEXTVAL, 9, 8);
INSERT INTO SGIPA.TB_AMR_AGENDAMENTO_DOC (AUTONUM, AUTONUM_AGENDAMENTO_DOC, AUTONUM_TIPO_DOC) VALUES (SEQ_AMR_AGENDAMENTO_DOC.NEXTVAL, 9, 9);

INSERT INTO SGIPA.TB_AMR_AGENDAMENTO_DOC (AUTONUM, AUTONUM_AGENDAMENTO_DOC, AUTONUM_TIPO_DOC) VALUES (SEQ_AMR_AGENDAMENTO_DOC.NEXTVAL, 10, 1);
INSERT INTO SGIPA.TB_AMR_AGENDAMENTO_DOC (AUTONUM, AUTONUM_AGENDAMENTO_DOC, AUTONUM_TIPO_DOC) VALUES (SEQ_AMR_AGENDAMENTO_DOC.NEXTVAL, 10, 2);
INSERT INTO SGIPA.TB_AMR_AGENDAMENTO_DOC (AUTONUM, AUTONUM_AGENDAMENTO_DOC, AUTONUM_TIPO_DOC) VALUES (SEQ_AMR_AGENDAMENTO_DOC.NEXTVAL, 10, 8);
INSERT INTO SGIPA.TB_AMR_AGENDAMENTO_DOC (AUTONUM, AUTONUM_AGENDAMENTO_DOC, AUTONUM_TIPO_DOC) VALUES (SEQ_AMR_AGENDAMENTO_DOC.NEXTVAL, 10, 9);

ALTER TABLE OPERADOR.TB_MOTORISTAS
ADD (TEL_CELULAR VARCHAR2(20 BYTE));

COMMENT ON COLUMN 
OPERADOR.TB_MOTORISTAS.TEL_CELULAR IS 
'Número do Telefone Celular';

ALTER TABLE SGIPA.TB_ORDEM_CARREGAMENTO
ADD (TEL_CELULAR VARCHAR2(20 BYTE),
  ID_NEXTEL VARCHAR2(15 BYTE),
  FLAG_REGISTRO_LIB NUMBER(1),
  DT_REGISTRO_LIB DATE);
COMMIT;

CREATE OR REPLACE VIEW SGIPA.VW_AGENDA_CS
(AUTONUM_AG_CS, PROTOCOLO, NOME_MOTORISTA, CNH, PLACA_CAVALO, 
 PLACA_CARRETA, PERIODO, IMPRESSO, STATUS, NUM_DOC_SAIDA, 
 NUMERO_BL, NUM_DOCUMENTO, DESCR_DOCUMENTO, DT_FREE_TIME, DT_CHEGADA, 
 COD_TRANSPORTADORA, AUTONUM_CS, EMISSAO_DOC_SAIDA, SERIE_DOC_SAIDA, TIPO_DOC_SAIDA, 
 COR, MODELO, RENAVAM, LOTE, QTDE, 
 EMISSAO, SERIE, NOTAFISCAL, AUTONUM_GD_RESERVA, USUARIO_DDC, 
 ID_CONTEINER, CNTR)
AS 
SELECT DISTINCT a.autonum,
                   a.num_protocolo || '/' || a.ano_protocolo AS protocolo,
                   b.nome, b.cnh, c.placa_cavalo, c.placa_carreta,
                      TO_CHAR (d.periodo_inicial,
                               'DD/MM/YYYY HH24:MI'
                              )
                   || ' - '
                   || TO_CHAR (d.periodo_final, 'DD/MM/YYYY HH24:MI')
                                                                   AS periodo,
                   DECODE (a.impresso, 0, 'Não', 1, 'Sim',2, 'Pendente') impresso,
                   DECODE (a.status, 1, 'Pendente', 0, 'Concluído') status,
                   a.num_doc_saida, bl.numero, bl.num_documento, td.descr,
                   cs.dt_fim_periodo AS free_time,
                   TO_CHAR (oc.data_ordem,
                            'DD/MM/YYYY HH24:MI'
                           ) AS data_chegada,
                   a.autonum_transportadora, nf.autonum_cs,
                   a.emissao_doc_saida, a.serie_doc_saida, a.tipo_doc_saida,
                   c.cor, c.modelo, c.renavam, bl.autonum AS lote, nf.qtde,
                   nf.emissao, nf.serie, nf.notafiscal, a.autonum_gd_reserva, cs.usuario_ddc, cntr.id_conteiner, a.cntr
              FROM sgipa.tb_ag_cs a LEFT JOIN operador.tb_ag_motoristas b
                   ON a.autonum_motorista = b.autonum
                   LEFT JOIN operador.tb_ag_veiculos c
                   ON a.autonum_veiculo = c.autonum
                   LEFT JOIN operador.tb_gd_reserva d
                   ON a.autonum_gd_reserva = d.autonum_gd_reserva
                   LEFT JOIN sgipa.tb_ag_cs_nf nf
                   ON nf.autonum_agendamento = a.autonum
                   LEFT JOIN sgipa.tb_carga_solta cs
                   ON cs.autonum = nf.autonum_cs
                   LEFT JOIN sgipa.tb_bl bl ON bl.autonum = CS.BL
                   LEFT JOIN sgipa.tb_tipos_documentos td
                   ON bl.tipo_documento = td.code
                   LEFT JOIN
                   (SELECT   MAX (ordem_carreg) ordem, cs
                        FROM sgipa.tb_registro_saida_cs
                    GROUP BY cs) rcs ON cs.autonum = rcs.cs
                   LEFT JOIN sgipa.tb_ordem_carregamento oc
                   ON rcs.ordem = oc.autonum
                   left join tb_cntr_bl cntr on a.cntr = cntr.autonum
             WHERE bl.ultima_saida IS NULL
             AND
             (nf.autonum is not null or b.nome is not null);

commit;

ALTER TABLE SGIPA.TB_CAD_USUARIOS ADD FLAG_DOCUMENTOS_AGENDAMENTO NUMBER(1);
UPDATE SGIPA.TB_CAD_USUARIOS SET FLAG_DOCUMENTOS_AGENDAMENTO = 1 WHERE USUARIO = 'MICROLED';

ALTER TABLE TB_AV_IMAGEM ADD AUTONUM_AGENDAMENTO_DOC NUMBER;
ALTER TABLE TB_ORDEM_CARREGAMENTO ADD ID_ENVIO_SMS NUMERIC;
ALTER TABLE TB_ORDEM_CARREGAMENTO ADD STATUS_ENVIO_SMS VARCHAR(250);